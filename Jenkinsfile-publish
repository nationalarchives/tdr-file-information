library(tdr-jenkinslib)

def versionBumpBranch = "version-bump-${BUILD_NUMBER}-${params.VERSION}"

pipeline {
  agent none

  parameters {
    choice(name: "VERSION", choices: ["patch", "minor", "major"], description: "The stage you are building the front end for")
  }
  stages {
    stage("Publish package and commit changes to GitHub") {
        agent {
            ecs {
                inheritFrom "npm"
            }
        }
        steps {
          script {
            tdr.configureJenkinsGitUser()
          }

          sh "git checkout ${versionBumpBranch}"

          script {
            tdr.pushGitHubBranch(versionBumpBranch)
          }

          sh 'npm ci'
          sh 'npm run build:prod'

          //commits change to the branch
          sshagent(['github-jenkins']) {
            sh "npm version ${params.VERSION}"
          }
            
          withCredentials([string(credentialsId: 'npm-login', variable: 'LOGIN_TOKEN')]) {
            sh "npm config set //registry.npmjs.org/:_authToken=$LOGIN_TOKEN"
            sh 'npm publish --access public'
          }
        }
    }
    stage("Create version bump pull request") {
      agent {
        label "master"
      }
      steps {
        script {
          tdr.createGitHubPullRequest(
            pullRequestTitle: "Version Bump from build number ${BUILD_NUMBER}",
            buildUrl: env.BUILD_URL,
            repo: "tdr-file-metadata",
            branchToMergeTo: "master",
            branchToMerge: versionBumpBranch
          )
        }
      }
    }
  }
}
